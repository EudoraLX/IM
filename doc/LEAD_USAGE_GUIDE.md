# 线索使用指南

## 线索是什么？

线索（Lead）是指潜在的客户信息，包含：
- 客户姓名
- 联系电话
- 来源渠道（官网预约、抖音推广、线下活动等）
- 状态（新线索、跟进中、已转化、已失效）

## 线索的完整使用流程

### 第一步：导入/创建线索

#### 方式1：单个新增
1. 进入"线索管理"页面
2. 点击"新增线索"按钮
3. 填写客户信息：
   - 客户姓名
   - 联系电话
   - 来源渠道
   - 状态（默认：新线索）
4. 点击"确定"保存

#### 方式2：批量导入
1. 进入"线索管理"页面
2. 点击"批量导入"按钮
3. 上传Excel文件或填写JSON数据
4. 系统自动导入多条线索

**导入后的自动处理**：
- 线索存入 `lead` 表
- 系统自动检查这些线索是否符合高潜条件
- 如果符合，自动创建高潜线索记录

### 第二步：配置监控指标（决定哪些线索是高潜）

1. 进入"监控指标管理"页面
2. 配置监控条件：
   - **监控时间范围**：例如7天（线索在7天内的行为会被监控）
   - **活跃机构**：选择要监控的机构（如：华东中心机构、上海研发分部）
   - **活跃次数阈值**：例如3次（线索活跃次数超过3次才算高潜）
3. 点击"提交保存"

**作用**：这些配置决定了什么样的线索会被筛选为"高潜线索"

### 第三步：自动数据加工（系统自动执行）

系统会根据监控指标配置，自动筛选高潜线索：

**执行时机**：
1. **定时任务**：每天凌晨1点自动执行（T+1更新）
2. **批量导入后**：导入线索后自动执行
3. **手动触发**：调用API `POST /api/dataProcessing/process`

**筛选逻辑**：
```
对于每条线索，系统会检查：
1. 线索是否在监控时间范围内（例如：最近7天）
2. 线索是否属于活跃机构
3. 线索的活跃次数是否超过阈值（例如：≥3次）
4. 其他业务规则（如：新线索、特定来源渠道等）

如果符合条件 → 创建高潜线索记录
如果不符合 → 不处理
```

**结果**：筛选出的高潜线索会存入 `high_potential_lead` 表

### 第四步：查看和执行营销

1. 进入"高潜线索营销"页面
2. 查看统计信息：
   - 命中用户总数
   - 今日新增线索
   - 待营销处理数量
   - 营销转化成功率
3. 查看高潜线索列表：
   - 每条线索显示：用户ID、命中规则、来源系统、命中日期、状态
4. 执行营销动作：
   - **批量外呼**：选择多条线索，点击"批量外呼营销"
   - **批量发送短信**：选择多条线索，点击"批量发送短信"
   - **单独联系**：点击单条线索的"单独联系"按钮
5. 跟踪营销结果：
   - 更新线索状态（营销进行中、营销已转化、已联系失效）

## 线索状态流转

```
新线索 → 跟进中 → 已转化
  ↓        ↓
已失效   已失效
```

### 线索状态说明

- **新线索**：刚导入的线索，还未处理
- **跟进中**：正在跟进处理的线索
- **已转化**：成功转化为客户的线索
- **已失效**：无效或过期的线索

## 高潜线索的生成规则

### 规则1：活跃机构匹配
- 如果线索的来源渠道匹配监控指标中配置的活跃机构
- 则认为是高潜线索

### 规则2：活跃次数阈值
- 如果线索在监控时间范围内的活跃次数 ≥ 阈值
- 则认为是高潜线索

### 规则3：新线索优先
- 如果线索状态为"新线索"且创建时间在监控范围内
- 则认为是高潜线索

**注意**：实际业务中，应该根据第三方数据（人脸验证、OCR验证等事件日志）来计算活跃次数，当前为简化实现。

## 实际使用场景示例

### 场景1：冷启动（首次使用）

1. **导入线索**
   ```
   在"线索管理"页面批量导入100条线索
   ```

2. **使用默认配置**（系统已预设）
   - 监控时间范围：7天
   - 活跃机构：华东中心机构、上海研发分部
   - 活跃次数阈值：3次

3. **自动筛选**
   ```
   系统自动执行数据加工
   → 从100条线索中筛选出20条高潜线索
   → 存入 high_potential_lead 表
   ```

4. **执行营销**
   ```
   在"高潜线索营销"页面
   → 查看20条高潜线索
   → 批量发送短信或外呼
   ```

### 场景2：日常运营

1. **每天导入新线索**
   ```
   每天在"线索管理"页面导入新线索
   ```

2. **定时自动处理**
   ```
   系统每天凌晨1点自动执行数据加工
   → 筛选出新的高潜线索
   ```

3. **每天查看和执行**
   ```
   每天在"高潜线索营销"页面
   → 查看新增的高潜线索
   → 执行营销动作
   ```

### 场景3：调整监控策略

1. **修改监控指标**
   ```
   在"监控指标管理"页面调整配置：
   - 将活跃次数阈值从3次改为5次
   - 添加新的活跃机构
   ```

2. **重新执行数据加工**
   ```
   手动触发数据加工（或等待定时任务）
   → 根据新配置重新筛选高潜线索
   ```

3. **查看新的高潜线索**
   ```
   在"高潜线索营销"页面查看筛选结果
   ```

## 线索数据表结构

### lead 表（线索表）
- `id`：线索ID
- `lead_no`：线索编号（自动生成，如：L1767085350982）
- `customer_name`：客户姓名
- `contact_phone`：联系电话
- `source_channel`：来源渠道
- `status`：状态
- `create_time`：创建时间
- `deleted`：是否删除（0-未删除，1-已删除）

### high_potential_lead 表（高潜线索表）
- `id`：高潜线索ID
- `lead_id`：关联的线索ID（外键）
- `user_id`：用户ID
- `matching_rule`：命中规则（如：活跃机构命中）
- `lead_source_system`：线索来源系统
- `matching_date`：命中日期
- `status`：状态（待营销处理、营销进行中、营销已转化、已联系失效）
- `high_potential_reason`：高潜原因
- `lead_level`：线索分级（A-高潜，B-中潜，C-低潜）

## 常见问题

### Q1: 导入线索后，为什么看不到高潜线索？
**A**: 
1. 检查是否配置了监控指标（"监控指标管理"页面）
2. 检查线索是否符合监控条件
3. 手动触发数据加工：`POST /api/dataProcessing/process`
4. 检查"高潜线索营销"页面的筛选条件

### Q2: 如何修改筛选规则？
**A**: 
1. 在"监控指标管理"页面修改配置
2. 保存后，手动触发数据加工或等待定时任务执行
3. 系统会根据新配置重新筛选

### Q3: 线索删除后，高潜线索会怎样？
**A**: 
- 如果物理删除线索，关联的高潜线索记录仍然存在（但关联的线索ID无效）
- 建议使用逻辑删除（设置 deleted=1），这样数据可以恢复

### Q4: 如何查看线索的详细信息？
**A**: 
- 在"线索管理"页面，点击线索行的"查看"按钮
- 或直接查询数据库 `lead` 表

### Q5: 高潜线索可以手动添加吗？
**A**: 
- 当前版本不支持手动添加高潜线索
- 高潜线索只能通过数据加工服务自动筛选生成
- 如需手动添加，可以直接操作数据库 `high_potential_lead` 表

## 最佳实践

1. **定期导入线索**：建议每天或每周批量导入新线索
2. **合理配置监控指标**：根据业务实际情况调整监控条件
3. **及时处理高潜线索**：筛选出的高潜线索应及时跟进，避免过期
4. **跟踪营销效果**：及时更新线索状态，便于分析转化率
5. **定期优化规则**：根据转化效果，调整监控指标配置

## API接口使用

### 手动触发数据加工
```bash
POST http://localhost:8080/api/dataProcessing/process
```

### 批量处理指定线索
```bash
POST http://localhost:8080/api/dataProcessing/batchProcess
Content-Type: application/json

[1, 2, 3, 4, 5]  # 线索ID列表
```

### 检查单个线索是否为高潜
```bash
GET http://localhost:8080/api/dataProcessing/check/1
```

