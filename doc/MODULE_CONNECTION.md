# 四个模块连接说明

## 业务流程概览

```
线索管理 → 监控指标配置 → 推送频率配置 → 数据加工服务 → 高潜线索营销
   ↓            ↓              ↓              ↓              ↓
导入线索    设置监控条件    设置推送策略    自动筛选高潜    执行营销动作
```

## 详细连接流程

### 1. 线索管理模块
**功能**：导入和管理线索数据
- 导入线索到 `lead` 表
- 管理线索的基本信息（姓名、电话、来源渠道等）

**输出**：线索数据存储在 `lead` 表中

### 2. 监控指标管理模块
**功能**：配置监控条件
- 设置监控时间范围（天数）
- 选择活跃机构
- 设置活跃次数阈值

**输出**：监控配置存储在 `monitor_indicator` 表中

**连接点**：数据加工服务会读取这些配置，用于筛选高潜线索

### 3. 推送频率管理模块
**功能**：配置推送频率策略
- 设置推送间隔
- 配置每周分布策略
- 设置周末规则

**输出**：推送配置存储在 `push_frequency` 表中

**连接点**：可以用于控制高潜线索的推送频率（未来扩展）

### 4. 数据加工服务（核心连接模块）
**功能**：根据监控指标自动筛选高潜线索

**工作流程**：
1. 读取监控指标配置（`monitor_indicator` 表）
2. 读取所有未删除的线索（`lead` 表）
3. 根据监控指标规则判断哪些线索是高潜线索：
   - 检查线索是否在监控时间范围内
   - 检查线索是否属于活跃机构
   - 检查线索活跃次数是否超过阈值
4. 将筛选出的高潜线索存入 `high_potential_lead` 表

**执行方式**：
- **定时任务**：每天凌晨1点自动执行（T+1更新）
- **手动触发**：通过API接口手动触发

**API接口**：
- `POST /api/dataProcessing/process` - 手动触发数据加工
- `POST /api/dataProcessing/batchProcess` - 批量处理指定线索
- `GET /api/dataProcessing/check/{leadId}` - 检查单个线索是否为高潜

### 5. 高潜线索营销模块
**功能**：展示和执行营销动作
- 展示筛选出的高潜线索列表
- 批量外呼营销
- 批量发送短信
- 跟踪营销状态

**数据来源**：从 `high_potential_lead` 表读取高潜线索数据

## 完整业务流程示例

### 场景：新线索导入后的自动化处理

1. **导入线索**
   ```
   用户在"线索管理"页面导入线索
   → 线索存入 lead 表
   ```

2. **配置监控指标**（首次配置或修改）
   ```
   用户在"监控指标管理"页面配置：
   - 监控时间范围：7天
   - 活跃机构：华东中心机构、上海研发分部
   - 活跃次数阈值：3次
   → 配置存入 monitor_indicator 表
   ```

3. **配置推送频率**（可选）
   ```
   用户在"推送频率管理"页面配置推送策略
   → 配置存入 push_frequency 表
   ```

4. **自动数据加工**（定时任务或手动触发）
   ```
   数据加工服务执行：
   - 读取监控指标配置
   - 读取所有线索
   - 根据规则筛选高潜线索
   - 存入 high_potential_lead 表
   ```

5. **查看和执行营销**
   ```
   用户在"高潜线索营销"页面：
   - 查看筛选出的高潜线索
   - 执行批量外呼或发送短信
   - 跟踪营销结果
   ```

## 数据流转图

```
┌─────────────────┐
│   线索管理      │
│  (lead 表)      │
└────────┬────────┘
         │
         │ 提供线索数据
         ↓
┌─────────────────┐
│ 监控指标管理    │ ───┐
│ (monitor_       │    │
│  indicator表)   │    │
└─────────────────┘    │
                       │
┌─────────────────┐    │
│ 推送频率管理    │    │ 提供配置
│ (push_frequency │    │
│  表)            │    │
└─────────────────┘    │
                       │
                       ↓
              ┌─────────────────┐
              │ 数据加工服务    │
              │ (定时任务/手动)  │
              └────────┬────────┘
                       │
                       │ 筛选高潜线索
                       ↓
              ┌─────────────────┐
              │ high_potential_ │
              │ lead 表         │
              └────────┬────────┘
                       │
                       │ 提供高潜线索
                       ↓
              ┌─────────────────┐
              │ 高潜线索营销    │
              │ (展示和执行)     │
              └─────────────────┘
```

## 关键连接点

### 1. 监控指标 → 数据加工
- **位置**：`DataProcessingServiceImpl.processDataAndFilterHighPotentialLeads()`
- **逻辑**：读取 `monitor_indicator` 表的配置，用于筛选规则

### 2. 线索数据 → 数据加工
- **位置**：`DataProcessingServiceImpl.processDataAndFilterHighPotentialLeads()`
- **逻辑**：读取 `lead` 表的所有未删除线索，进行筛选

### 3. 数据加工 → 高潜线索
- **位置**：`DataProcessingServiceImpl.createHighPotentialLead()`
- **逻辑**：将筛选出的高潜线索存入 `high_potential_lead` 表

### 4. 高潜线索 → 营销执行
- **位置**：`HighPotentialLeadServiceImpl`
- **逻辑**：从 `high_potential_lead` 表读取数据，执行营销动作

## 定时任务配置

数据加工任务配置在 `DataProcessingTask` 类中：

- **每日任务**：每天凌晨1点执行（`@Scheduled(cron = "0 0 1 * * ?")`）
- **每小时任务**：已注释，可根据需要启用

## 手动触发

可以通过以下方式手动触发数据加工：

1. **API调用**：
   ```bash
   POST http://localhost:8080/api/dataProcessing/process
   ```

2. **前端按钮**（可扩展）：
   在"监控指标管理"或"高潜线索营销"页面添加"立即执行数据加工"按钮

## 扩展建议

1. **实时处理**：可以在线索导入后立即触发数据加工
2. **推送频率应用**：根据推送频率配置，控制高潜线索的推送时机
3. **数据源对接**：对接第三方数据源（人脸验证、OCR验证等事件日志），实现更精确的筛选
4. **线索分级优化**：根据更多维度（活跃度、转化概率等）进行线索分级

